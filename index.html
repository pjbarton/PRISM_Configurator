<!DOCTYPE html>
<html lang="en">
	<head>
		<title>PRISM Configurator</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 100%;
				text-align: center;
				z-index: 0;
				display:block;
			}
			a { color: skyblue }
			.button { background:#999; color:#eee; padding:0.2em 0.5em; cursor:pointer }
			.highlight { background:orange; color:#fff; }
			span {
				display: inline-block;
				width: 60px;
				float: left;
				text-align: center;
			}
		</style>
	</head>
	<body>
		<link rel="icon" href="favicon.ico"/>
		<div id="info">
			<p style="color:#A0A0A0; font-size:150%">PRISM Configurator</p>
		</div>

		<script type="text/javascript" src="js/three.min.js"></script>
		<script type="text/javascript" src="js/PLYloader.js"></script>
		<script type="text/javascript" src="js/Detector.js"></script>
		<script type="text/javascript" src="js/stats.min.js"></script>
		<script type="text/javascript" src="js/OrbitControls.js"></script>
		<script type="text/javascript" src="js/dat.gui.min.js"></script>
	
		<script type="text/javascript">
			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
			window.addEventListener( 'resize', onWindowResize, false );
			window.addEventListener( 'load', init );

			var container, stats;
			var camera, cameraTarget, scene, renderer, controls, lightTop, lightAmbient, mesh;
			var params = {
				mask: 'FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF',
				//mask: '21524FA4 78BD521A B4479132 2B545C97 9943A029 753854BB',
				angTheta: 0.0,
				angPhi: Math.PI/2,
				rotateSpeed: 0.4,
				autorotate: true,
				colorAmbient: "#657ff7",
				colorTop: "#e8e864",
				colorBack: "#404040",
				resetPosition: function() { 
					controls.reset(); 
				},
				showAxes: false
			};

			function loadPLY(mask){
				var loader = new THREE.PLYLoader();
				loader.load( 'models/PRISM-1_0_quad.ply', function ( geometry ) {
					
					geometry.computeFaceNormals();
					//geometry.dynamic = true;
					//geometry.verticesNeedUpdate = true;
					var material = new THREE.MeshStandardMaterial;
					mesh = new THREE.Mesh( geometry, material );
					
					var faceID = 0;
					for (var i = mesh.geometry.faces.length - 12; i >= 0; i -= 12) {
						if ( mask[faceID] == '0' ) {
							mesh.geometry.faces.splice(-i,12);
						}
						faceID++;
					}

					//mesh.geometry.faces.splice(0,12*192/2);
					scene.add( mesh );

				} );
			}

			String.prototype.hex2bin = function () {
				var s = this.toUpperCase().trim().replace(/ /g,'');
				var sReturn = '';
				var lookupTable = {
			        '0': '0000', '1': '0001', '2': '0010', '3': '0011', '4': '0100', '5': '0101', '6': '0110', '7': '0111', '8': '1000', '9': '1001',
			        'A': '1010', 'B': '1011', 'C': '1100', 'D': '1101', 'E': '1110', 'F': '1111' };
			    for (var i = 0; i < s.length; i++) {
			        if ( lookupTable.hasOwnProperty(s[i]) ) 
			            sReturn += lookupTable[s[i]];
			    }
			    return sReturn
			}

			function init() {
				container = document.createElement( 'div' );
				document.body.appendChild( container );
				
				stats = new Stats();
				container.appendChild( stats.dom );
				
				// Renderer
				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.gammaInput = true;
				renderer.gammaOutput = true;
				container.appendChild( renderer.domElement );
				
				// Camera / Scene
				meshWidth = 200 * window.innerWidth / window.innerHeight;
				meshHeight = 200 ;
				camera = new THREE.OrthographicCamera( meshWidth / - 2, meshWidth / 2, meshHeight / 2, meshHeight / - 2, 1, 200 );
				camera.position.z = 100;
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				scene = new THREE.Scene();

				// Controls
				controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.enableDamping = true;
				controls.dampingFactor = 0.25;
				controls.enableZoom = true;
				controls.enablePan = false;
				controls.rotateSpeed = 0.2;
				controls.autoRotate = true;
				controls.autoRotateSpeed = 0.1;

				// Model
				//loadPLY(params.mask.hex2bin());
				
				// Lights
				lightTop = new THREE.HemisphereLight( 0xffffff, 0x000000 );
				lightAmbient = new THREE.AmbientLight( 0x8000A0 );
				scene.add( lightTop );
				scene.add( lightAmbient );

				// GUI
				var valuesChanger = function() {
					scene.remove( mesh );
					loadPLY(params.mask.hex2bin());
					controls.autoRotate = params.autorotate;
					controls.autoRotateSpeed = params.rotateSpeed;
					lightTop.color.setHex( params.colorTop.replace( '#','0x' ) );
					lightAmbient.color.setHex( params.colorAmbient.replace( '#','0x' ) );
					renderer.setClearColor( params.colorBack, 1);

				}
				var gui = new dat.GUI();	
				gui.add(params, 'mask', {
					Full: 'FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF', 
					Random: '21524FA4 78BD521A B4479132 2B545C97 9943A029 753854BB'
				}).name('Mask').listen().onChange( valuesChanger );
				var f1 = gui.addFolder('Rotation');
				f1.add(params, 'angTheta', -Math.PI, Math.PI).name('( Theta )').listen().onChange( valuesChanger ).step(0.1);
				f1.add(params, 'angPhi', 0, Math.PI).name('( Phi )').listen().onChange( valuesChanger ).step(0.01);
				f1.add(params, 'autorotate').listen().onChange( valuesChanger );
				f1.add(params, 'rotateSpeed',0.0,2).listen().onChange( valuesChanger ).step(0.01);
				f1.add(params, 'resetPosition').name('Reset Position');
				f1.open();
				var f2 = gui.addFolder('Color');
				f2.addColor(params, 'colorAmbient').name('Ambient').listen().onChange( valuesChanger );
				f2.addColor(params, 'colorTop').name('Top').listen().onChange( valuesChanger );
				f2.addColor(params, 'colorBack').name('Background').listen().onChange( valuesChanger );
				f2.open();

				valuesChanger();
				onWindowResize();
				animate();
			}

			function onWindowResize() {

				meshWidth = 200 * window.innerWidth / window.innerHeight;
				meshHeight = 200 ;
				camera.left = meshWidth / - 2;
				camera.right = meshWidth / 2;
				camera.top = meshHeight / 2;
				camera.bottom = meshHeight / - 2;
				camera.updateProjectionMatrix();
				
				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			function animate() {

				params.angTheta = controls.getAzimuthalAngle();
				params.angPhi = controls.getPolarAngle();
				requestAnimationFrame( animate );
				controls.update();
				stats.update();
				render();
			}

			function render() {

				renderer.render( scene, camera );
			}
		</script>
	</body>
</html>
